<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A modern WordPress content feed with smooth loading and filtering">
    <title>WP Content Feed</title>
    <link href="app/css/tailwind.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
        }
        
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 0.8s ease-in-out infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
    
    <!-- Core Modules -->
    <script type="module" src="app/js/core/config.js"></script>
    <script type="module" src="app/js/core/state.js"></script>
    
    <!-- Services -->
    <script type="module" src="app/js/services/api.js"></script>
    
    <!-- Components -->
    <script type="module" src="app/js/components/popover.js"></script>
    
    <!-- Views -->
    <script type="module" src="app/js/views/baseView.js"></script>
    <script type="module" src="app/js/views/feedView.js"></script>
    
    <!-- Main App -->
    <script type="module" src="app/js/app.js"></script>
    
    <!-- Mock data for development -->
    <script>
        // Only use mock data in development
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('Running in development mode, setting up mock data...');
            
            // Initialize State if not already defined
            if (!window.State) {
                window.State = {
                    _state: {},
                    _listeners: {},
                    get: function(key) {
                        return this._state[key];
                    },
                    set: function(key, value) {
                        this._state[key] = value;
                        if (this._listeners[key]) {
                            this._listeners[key].forEach(callback => callback(value));
                        }
                    },
                    subscribe: function(key, callback) {
                        if (!this._listeners[key]) {
                            this._listeners[key] = [];
                        }
                        this._listeners[key].push(callback);
                        // Return unsubscribe function
                        return () => {
                            this._listeners[key] = this._listeners[key].filter(cb => cb !== callback);
                        };
                    }
                };
            }
            
            // Mock wpApiSettings if not defined by WordPress
            if (!window.wpApiSettings) {
                window.wpApiSettings = {
                    root: window.location.origin + '/wp-json/',
                    nonce: 'mock-nonce-for-development',
                    versionString: 'wp/v2/'
                };
            }
            
            // Mock API response for post types
            window.mockPostTypes = {
                post: {
                    name: 'Posts',
                    slug: 'post',
                    rest_base: 'posts',
                    supports: ['title', 'editor', 'author', 'thumbnail', 'excerpt', 'comments']
                },
                page: {
                    name: 'Pages',
                    slug: 'page',
                    rest_base: 'pages',
                    supports: ['title', 'editor', 'author', 'thumbnail', 'excerpt', 'comments']
                }
            };
            
            // Mock posts data
            window.mockPosts = [
                {
                    id: 1,
                    date: new Date().toISOString(),
                    title: { rendered: 'Welcome to WP Content Feed' },
                    excerpt: { rendered: 'This is a sample post to demonstrate the feed functionality.' },
                    content: { rendered: '<p>This is the full content of the sample post. It includes some example text to demonstrate how the feed displays posts.</p>' },
                    _embedded: {
                        'wp:featuredmedia': [{
                            source_url: 'https://via.placeholder.com/800x450?text=Featured+Image',
                            alt_text: 'Sample featured image',
                            media_details: {
                                sizes: {
                                    thumbnail: {
                                        source_url: 'https://via.placeholder.com/150x150?text=Thumb'
                                    },
                                    medium: {
                                        source_url: 'https://via.placeholder.com/300x169?text=Medium'
                                    },
                                    large: {
                                        source_url: 'https://via.placeholder.com/800x450?text=Large'
                                    },
                                    full: {
                                        source_url: 'https://via.placeholder.com/800x450?text=Featured+Image'
                                    }
                                }
                            }
                        }],
                        'wp:term': [
                            [
                                { id: 1, name: 'News', taxonomy: 'category', link: '#' },
                                { id: 2, name: 'Updates', taxonomy: 'category', link: '#' }
                            ],
                            [
                                { id: 1, name: 'Featured', taxonomy: 'post_tag', link: '#' },
                                { id: 2, name: 'Example', taxonomy: 'post_tag', link: '#' }
                            ]
                        ]
                    },
                    link: '#',
                    type: 'post',
                    categories: [1],
                    tags: [1, 2]
                },
                {
                    id: 2,
                    date: new Date(Date.now() - 86400000).toISOString(),
                    title: { rendered: 'Getting Started with WordPress' },
                    excerpt: { rendered: 'Learn how to get started with WordPress and create amazing websites.' },
                    content: { rendered: '<p>WordPress is a powerful content management system that powers millions of websites. This post will guide you through the basics of getting started.</p>' },
                    _embedded: {
                        'wp:featuredmedia': [{
                            source_url: 'https://via.placeholder.com/800x450?text=WordPress',
                            alt_text: 'WordPress logo',
                            media_details: {
                                sizes: {
                                    thumbnail: {
                                        source_url: 'https://via.placeholder.com/150x150?text=WP+Thumb'
                                    },
                                    medium: {
                                        source_url: 'https://via.placeholder.com/300x169?text=WP+Medium'
                                    },
                                    large: {
                                        source_url: 'https://via.placeholder.com/800x450?text=WP+Large'
                                    },
                                    full: {
                                        source_url: 'https://via.placeholder.com/800x450?text=WordPress'
                                    }
                                }
                            }
                        }],
                        'wp:term': [
                            [
                                { id: 1, name: 'News', taxonomy: 'category', link: '#' }
                            ],
                            [
                                { id: 2, name: 'Example', taxonomy: 'post_tag', link: '#' }
                            ]
                        ]
                    },
                    link: '#',
                    type: 'post',
                    categories: [1],
                    tags: [2]
                }
            ];
            
            // Override fetch for development
            const originalFetch = window.fetch;
            window.fetch = async function(url, options) {
                console.log('Fetching:', url);
                
                // Convert relative URLs to absolute
                if (url.startsWith('/')) {
                    url = new URL(url, window.location.origin).toString();
                }
                
                // Mock post types endpoint
                if (url.includes('/wp-json/wp/v2/types') || url.endsWith('/types')) {
                    console.log('Returning mock post types');
                    return Promise.resolve({
                        ok: true,
                        status: 200,
                        json: () => Promise.resolve(window.mockPostTypes),
                        headers: {
                            get: (header) => {
                                const headers = {
                                    'Content-Type': 'application/json',
                                    'X-WP-Total': Object.keys(window.mockPostTypes).length,
                                    'X-WP-TotalPages': 1
                                };
                                return headers[header];
                            }
                        }
                    });
                }
                
                // Mock posts endpoint
                if (url.includes('/wp-json/wp/v2/posts') || url.endsWith('/posts')) {
                    console.log('Returning mock posts');
                    // Handle pagination
                    const urlObj = new URL(url, window.location.origin);
                    const page = parseInt(urlObj.searchParams.get('page')) || 1;
                    const perPage = parseInt(urlObj.searchParams.get('per_page')) || 10;
                    const start = (page - 1) * perPage;
                    const end = start + perPage;
                    const paginatedPosts = window.mockPosts.slice(start, end);
                    
                    return Promise.resolve({
                        ok: true,
                        status: 200,
                        json: () => Promise.resolve(paginatedPosts),
                        headers: {
                            get: (header) => {
                                const headers = {
                                    'Content-Type': 'application/json',
                                    'X-WP-Total': window.mockPosts.length,
                                    'X-WP-TotalPages': Math.ceil(window.mockPosts.length / perPage)
                                };
                                return headers[header];
                            }
                        }
                    });
                }
                
                // For any other API requests, ensure CORS headers are set
                if (options && options.headers) {
                    options.headers = {
                        ...options.headers,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    };
                }
                
                // Default to original fetch with CORS headers
                return originalFetch(url, options).then(response => {
                    // Clone the response so we can modify the headers
                    const modifiedResponse = response.clone();
                    
                    // If this is a CORS preflight request, add the necessary headers
                    if (response.status === 204 && options && options.method === 'OPTIONS') {
                        const headers = new Headers(modifiedResponse.headers);
                        headers.set('Access-Control-Allow-Origin', window.location.origin);
                        headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
                        headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');
                        headers.set('Access-Control-Allow-Credentials', 'true');
                        
                        return new Response(null, {
                            status: 204,
                            headers: headers
                        });
                    }
                    
                    return modifiedResponse;
                });
            };
        }
    </script>
    
    <!-- Initialize App -->
    <script type="module">
        import { app } from './app/js/app.js';
        
        // Make app globally available for debugging
        window.app = app;
        
        // Initialize popover functionality if available
        function initPopover() {
            if (window.Popover) {
                // Set up popover close handlers
                document.addEventListener('click', function(e) {
                    const popover = document.getElementById('popover-container');
                    if (e.target === popover && window.Popover.close) {
                        window.Popover.close();
                    }
                });
                
                // Close popover on escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && window.Popover.close) {
                        window.Popover.close();
                    }
                });
            }
        }
        
        // Handle filter buttons
        function setupFilters() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const filterType = this.dataset.filter;
                    const filterValue = this.dataset.value;
                    
                    // Update active state
                    document.querySelectorAll(`[data-filter="${filterType}"]`).forEach(btn => {
                        btn.classList.remove('bg-indigo-600', 'text-white');
                        btn.classList.add('bg-indigo-100', 'text-indigo-800', 'hover:bg-indigo-200');
                    });
                    
                    this.classList.remove('bg-indigo-100', 'text-indigo-800', 'hover:bg-indigo-200');
                    this.classList.add('bg-indigo-600', 'text-white');
                    
                    // Update state and reload content
                    if (filterType === 'category') {
                        app.updateState({ activeCategory: filterValue });
                        app.loadContent(app.currentType);
                    } else if (filterType === 'tag') {
                        app.updateState({ activeTag: filterValue });
                        app.loadContent(app.currentType);
                    } else if (filterType === 'type') {
                        app.updateState({ currentType: filterValue });
                        app.loadContent(filterValue);
                    }
                });
            });
        }
        
        // Handle search form
        function setupSearch() {
            const searchForm = document.getElementById('search-form');
            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const searchInput = this.querySelector('input[type="search"]');
                    if (searchInput) {
                        app.updateState({ searchQuery: searchInput.value.trim() });
                        app.loadContent(app.currentType);
                    }
                });
            }
        }
        
        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded, initializing app...');
            
            try {
                // Initialize app
                app.init();
                
                // Set up UI components
                initPopover();
                setupFilters();
                setupSearch();
                
                console.log('Application initialized successfully');
            } catch (error) {
                console.error('Error initializing application:', error);
                app.showError('Failed to initialize the application. Please check the console for details.');
            }
        });
    </script>
    </script>

    <!-- Settings Storage -->
    <script type="application/json" id="appSettings">
        {
            "loadMore": true,
            "initialItemsCount": 10,
            "itemsPerPage": 10,
            "sortDescending": true,
            "mainViewMode": "feed",
            "contentViewMode": "page",
            "itemSize": "medium",
            "wpApiBase": "https://your-wordpress-site.com/wp-json",
            "apiSource": "current"
        }
    </script>

</head>

<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- App Container -->
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-100">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo -->
                    <div class="flex-shrink-0 flex items-center">
                        <h1 class="text-xl font-bold text-gray-900">
                            <span class="text-indigo-600">WP</span> Content Feed
                        </h1>
                    </div>
                    
                    <!-- Search Form -->
                    <div class="flex-1 max-w-md px-4">
                        <form id="search-form" class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <input 
                                id="search-input"
                                type="text"
                                placeholder="Search posts..."
                                class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition duration-150 ease-in-out"
                            >
                        </form>
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="loading-indicator" class="flex items-center">
                        <div class="loading mr-2"></div>
                        <span class="text-sm text-gray-500 hidden sm:inline">Loading...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow bg-gray-50">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- Filters -->
                <div class="mb-6 flex flex-wrap gap-3">
                    <button data-filter="category" data-value="all" class="filter-btn px-4 py-2 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800 hover:bg-indigo-200 transition-colors">
                        All Categories
                    </button>
                    <button data-filter="category" data-value="news" class="filter-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-800 hover:bg-gray-200 transition-colors">
                        News
                    </button>
                    <button data-filter="category" data-value="updates" class="filter-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-800 hover:bg-gray-200 transition-colors">
                        Updates
                    </button>
                </div>
                
                <!-- Content Feed -->
                <div id="content-feed" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 p-6">
                    <!-- Feed items will be inserted here -->
                    <div class="text-center py-12 text-gray-500">
                        <div class="loading mx-auto mb-2"></div>
                        <p>Loading content...</p>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="loading-indicator" class="hidden text-center py-8">
                    <div class="loading mx-auto"></div>
                    <p class="mt-2 text-sm text-gray-500">Loading more content...</p>
                </div>
                
                <!-- End of Content Marker -->
                <div id="end-marker" class="h-10"></div>

                <!-- No Results -->
                <div id="no-results" class="hidden text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No results found</h3>
                    <p class="mt-1 text-sm text-gray-500">Try adjusting your search or filter to find what you're looking for.</p>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200 py-4">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <p class="text-sm text-gray-500">&copy; 2023 WP Content Feed. All rights reserved.</p>
                    <div class="mt-2 md:mt-0">
                        <a href="#" class="text-sm text-gray-500 hover:text-gray-700 mx-3">Privacy Policy</a>
                        <a href="#" class="text-sm text-gray-500 hover:text-gray-700 mx-3">Terms of Service</a>
                        <a href="#" class="text-sm text-gray-500 hover:text-gray-700 ml-3">Contact</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- Popover Container -->
    <div id="popover-container" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50 transition-opacity duration-300 ease-in-out"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div id="popover-content" class="bg-white rounded-lg shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300 ease-in-out scale-95 opacity-0">
                <!-- Popover content will be inserted here -->
                <div class="p-6">
                    <!-- Close Button -->
                    <div class="flex justify-end">
                        <button id="close-popover" class="text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 rounded-full p-1">
                            <span class="sr-only">Close</span>
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Popover Body -->
                    <div id="popover-body">
                        <!-- Content will be loaded here dynamically -->
                        <div class="text-center py-12">
                            <div class="loading mx-auto"></div>
                            <p class="mt-3 text-gray-600">Loading content...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- App Initialization -->
    <script>
                    }
                });
                
                // Close popover on escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && window.Popover.close) {
                        window.Popover.close();
                    }
                });
            }
        }
        
        // Handle filter buttons
        function setupFilters() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const filterType = this.dataset.filter;
                    const filterValue = this.dataset.value;
                    
                    // Update active state
                    document.querySelectorAll(`[data-filter="${filterType}"]`).forEach(btn => {
                        btn.classList.remove('bg-indigo-600', 'text-white');
                        btn.classList.add('bg-indigo-100', 'text-indigo-800', 'hover:bg-indigo-200');
                    });
                    
                    this.classList.remove('bg-indigo-100', 'text-indigo-800', 'hover:bg-indigo-200');
                    this.classList.add('bg-indigo-600', 'text-white');
                    
                    // Update state and reload content
                    if (filterType === 'category') {
                        app.updateState({ activeCategory: filterValue });
                        app.loadContent(app.currentType);
                    } else if (filterType === 'tag') {
                        app.updateState({ activeTag: filterValue });
                        app.loadContent(app.currentType);
                    } else if (filterType === 'type') {
                        app.updateState({ currentType: filterValue });
                        app.loadContent(filterValue);
                    }
                });
            });
        }
        
        // Handle search form
        function setupSearch() {
            const searchForm = document.getElementById('search-form');
            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const searchInput = this.querySelector('input[type="search"]');
                    if (searchInput) {
                        app.updateState({ searchQuery: searchInput.value.trim() });
                        app.loadContent(app.currentType);
                    }
                });
            }
        }
        
        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded, initializing app...');
            
            try {
                // Initialize app
                app.init();
                
                // Set up UI components
                initPopover();
                setupFilters();
                setupSearch();
                
                console.log('Application initialized successfully');
            } catch (error) {
                console.error('Error initializing application:', error);
                app.showError('Failed to initialize the application. Please check the console for details.');
            }
        });
        
        // Helper function to show error messages
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 z-50 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-lg';
            errorDiv.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                errorDiv.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                setTimeout(() => errorDiv.remove(), 500);
            }, 10000);
        }
    </script>


</body>
</html>